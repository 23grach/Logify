<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Design System Tracker</title>
  <style>
    /**
     * Enhanced global CSS reset and box-sizing for consistent rendering
     * across all browsers and elements with improved performance
     */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /**
     * Improved base body styling with system fonts and optimized layout
     * Uses flexbox for full-height layout management with enhanced performance
     */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      color: #1a1a1a;
      background: #ffffff;
      font-size: 14px;
      line-height: 1.5;
      height: 100vh;
      display: flex;
      flex-direction: column;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      overflow: hidden;
    }

    /**
     * CSS Custom Properties for consistent theming and easy customization
     */
    :root {
      --color-primary: #0066ff;
      --color-text: #1a1a1a;
      --color-text-secondary: #666666;
      --color-text-muted: #888888;
      --color-background: #ffffff;
      --color-background-secondary: #f5f5f5;
      --color-border: #f0f0f0;
      --color-border-hover: #e0e0e0;
      --color-success: #00cc44;
      --color-warning: #ff8800;
      --color-error: #ff4444;
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 12px;
      --spacing-lg: 16px;
      --spacing-xl: 20px;
      --border-radius: 6px;
      --border-radius-sm: 4px;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.15s ease;
    }

    /**
     * Enhanced main container with improved performance and accessibility
     * Uses CSS custom properties for consistent spacing
     */
    .container {
      display: flex;
      flex-direction: column;
      padding: var(--spacing-xl);
      gap: var(--spacing-lg);
      width: 100%;
      height: 100vh;
      min-height: 0;
      max-width: 100%;
      contain: layout style;
      overflow: hidden;
    }

    /**
     * Scrollable content area that contains the main UI elements
     * Handles overflow with custom scrollbar styling
     */
    .content-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      min-height: 0;
      padding-bottom: 8px;
      scroll-behavior: smooth;
    }

    /**
     * Custom webkit scrollbar styling for modern, minimal appearance
     * Applies to the main content container
     */
    .content-container::-webkit-scrollbar {
      width: 4px;
    }

    .content-container::-webkit-scrollbar-track {
      background: transparent;
    }

    .content-container::-webkit-scrollbar-thumb {
      background: #d0d0d0;
      border-radius: 2px;
      transition: background 0.15s ease;
    }

    .content-container::-webkit-scrollbar-thumb:hover {
      background: #a0a0a0;
    }

    /**
     * Firefox scrollbar styling for cross-browser consistency
     */
    .content-container {
      scrollbar-width: thin;
      scrollbar-color: #d0d0d0 transparent;
    }

    /**
     * Primary heading style with optimized typography
     * Uses negative letter-spacing for better visual density
     */
    .title {
      font-size: 20px;
      font-weight: 600;
      margin: 0;
      color: #1a1a1a;
      letter-spacing: -0.02em;
    }

    /**
     * Secondary heading style for section titles
     */
    .subtitle {
      font-size: 16px;
      font-weight: 500;
      margin: 0;
      color: #1a1a1a;
    }

    /**
     * Generic section container with consistent spacing
     */
    .section {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /**
     * Section header styling with uppercase transformation
     * Used for category labels and section dividers
     */
    .section-header {
      font-size: 14px;
      font-weight: 600;
      margin: 0;
      color: #666666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 11px;
    }

    /**
     * Container for item lists with subtle background and border radius
     * Creates visual grouping for related elements
     */
    .items-container {
      display: flex;
      flex-direction: column;
      width: 100%;
      gap: 1px;
      background: #f5f5f5;
      border-radius: 6px;
      overflow: hidden;
    }

    /**
     * Individual item styling within lists
     * Provides consistent spacing and typography for list elements
     */
    .item {
      display: flex;
      gap: 12px;
      align-items: center;
      font-size: 13px;
      line-height: 1.4;
      padding: 10px 12px;
      background: #ffffff;
      border-bottom: 1px solid #f0f0f0;
    }

    /**
     * Remove border from the last item in a list
     * for cleaner visual appearance
     */
    .item:last-child {
      border-bottom: none;
    }

    /**
     * Type indicator styling for items
     * Shows element type with consistent formatting
     */
    .item-type {
      font-weight: 500;
      color: #888888;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      min-width: 60px;
    }

    /**
     * Item name styling with flexible width
     * Allows names to expand and wrap as needed
     */
    .item-name {
      font-weight: 400;
      color: #1a1a1a;
      flex: 1;
    }

    /**
     * Enhanced styles for new UI components and features
     */
    .filter-container {
      display: flex;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      background: var(--color-background-secondary);
      border-radius: var(--border-radius);
      margin-bottom: var(--spacing-lg);
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
      flex: 1;
    }

    .filter-select,
    .filter-input {
      padding: var(--spacing-sm);
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius-sm);
      font-size: 13px;
      transition: var(--transition);
    }

    .filter-select:focus,
    .filter-input:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 2px rgba(0, 102, 255, 0.1);
    }

    .settings-panel {
      padding: var(--spacing-lg);
      background: var(--color-background);
      border-radius: var(--border-radius);
    }

    .settings-group {
      margin-bottom: var(--spacing-lg);
    }

    .settings-label {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      font-size: 14px;
      cursor: pointer;
    }

    .settings-checkbox {
      width: 16px;
      height: 16px;
    }

    .settings-select {
      padding: var(--spacing-sm);
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius-sm);
      background: var(--color-background);
      width: 100%;
    }

    .performance-dashboard {
      padding: var(--spacing-lg);
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }

    .metric-card {
      padding: var(--spacing-md);
      background: var(--color-background-secondary);
      border-radius: var(--border-radius);
      text-align: center;
    }

    .metric-value {
      font-size: 24px;
      font-weight: 600;
      color: var(--color-primary);
      line-height: 1.2;
    }

    .metric-label {
      font-size: 12px;
      color: var(--color-text-muted);
      margin-top: var(--spacing-xs);
    }

    .toast {
      font-size: 14px;
      box-shadow: var(--shadow-md);
      max-width: 300px;
      word-wrap: break-word;
    }

    /* Enhanced button states with better accessibility */
    .primary-button:focus-visible,
    .secondary-button:focus-visible {
      outline: 2px solid var(--color-primary);
      outline-offset: 2px;
    }

    /* Improved loading animation */
    @keyframes pulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }

    .loading-spinner {
      animation: pulse 1.5s infinite;
    }

    /* Better responsive design */
    @media (max-width: 320px) {
      .container {
        padding: var(--spacing-md);
        gap: var(--spacing-md);
      }
      
      .metrics-grid {
        grid-template-columns: 1fr;
      }
      
      .filter-container {
        flex-direction: column;
      }
    }

    /* Dark mode support (if needed in future) */
    @media (prefers-color-scheme: dark) {
      :root {
        --color-text: #ffffff;
        --color-background: #1a1a1a;
        --color-background-secondary: #2a2a2a;
        --color-border: #3a3a3a;
      }
    }

    /**
     * Action buttons container with consistent spacing
     * Fixed at bottom of interface with visual separation
     */
    .actions-container {
      display: flex;
      flex-direction: column;
      width: 100%;
      gap: 8px;
      border-top: 1px solid #f0f0f0;
      padding-top: 16px;
      margin-top: auto;
      flex-shrink: 0;
      background: var(--color-background);
      position: sticky;
      bottom: 0;
      z-index: 10;
    }

    /**
     * Base button styling with hover states and transitions
     * Provides consistent interactive elements throughout the UI
     */
    .button {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-family: inherit;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      background: #ffffff;
      color: #1a1a1a;
    }

    /**
     * Button hover state for improved user feedback
     */
    .button:hover {
      background: #f8f8f8;
      border-color: #d0d0d0;
    }

    /**
     * Primary button variant with brand color
     * Used for main actions and call-to-action elements
     */
    .button-primary {
      background: #007AFF;
      color: white;
      border-color: #007AFF;
    }

    /**
     * Primary button hover state with darker shade
     */
    .button-primary:hover {
      background: #0056CC;
      border-color: #0056CC;
    }

    /**
     * Disabled button state styling
     * Provides visual feedback for non-interactive buttons
     */
    .button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      background: #f5f5f5;
      color: #999999;
      border-color: #e0e0e0;
    }

    /**
     * Disabled button hover state override
     * Prevents hover effects on disabled buttons
     */
    .button:disabled:hover {
      background: #f5f5f5;
      border-color: #e0e0e0;
    }

    /**
     * Element count display styling
     * Shows metadata with subdued appearance
     */
    .element-count {
      font-size: 12px;
      color: #888888;
      margin: 0;
    }

    /**
     * Centered message container for loading and empty states
     * Provides consistent layout for informational content
     */
    .center-message {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      height: 100%;
      gap: 16px;
      padding: 32px 24px;
    }

    /**
     * Message text styling for informational content
     * Constrained width for better readability
     */
    .message-text {
      font-size: 14px;
      color: #666666;
      max-width: 280px;
      line-height: 1.4;
      margin: 0;
    }

    /**
     * Loading spinner animation element
     * CSS-only spinner with smooth rotation
     */
    .loading-spinner {
      width: 24px;
      height: 24px;
      border: 2px solid #f0f0f0;
      border-top: 2px solid #007AFF;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /**
     * Keyframe animation for loading spinner rotation
     */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /**
     * Visual divider element for section separation
     * Provides subtle visual breaks between content sections
     */
    .divider {
      height: 1px;
      background-color: #f0f0f0;
      margin: 8px 0;
      width: 100%;
    }
    
    /**
     * No changes message styling
     * Used when no modifications are detected
     */
    .no-changes {
      font-size: 13px;
      color: #888888;
      font-style: italic;
      padding: 20px 0;
      text-align: center;
    }
    
    /**
     * Base badge styling for count indicators
     * Provides consistent visual treatment for numeric badges
     */
    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 20px;
      height: 20px;
      padding: 0 6px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }
    
    /**
     * Badge variant for added elements
     * Green color scheme for positive additions
     */
    .badge-added {
      background-color: #E8F5E8;
      color: #2E7B32;
    }
    
    /**
     * Badge variant for changed elements
     * Orange color scheme for modifications
     */
    .badge-changed {
      background-color: #FFF4E6;
      color: #F57C00;
    }
    
    /**
     * Badge variant for removed elements
     * Red color scheme for deletions
     */
    .badge-removed {
      background-color: #FFEBEE;
      color: #D32F2F;
    }

    /**
     * Progress indicator container
     * Houses progress bar and percentage display
     */
    .progress-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      width: 100%;
      max-width: 160px;
      margin-top: 12px;
    }
    
    /**
     * Progress bar track styling
     * Background container for progress indicator
     */
    .progress-bar {
      width: 100%;
      height: 4px;
      background-color: #f0f0f0;
      border-radius: 2px;
      overflow: hidden;
    }
    
    /**
     * Progress bar fill element
     * Animated width changes to show progress
     */
    .progress-fill {
      height: 100%;
      background-color: #007AFF;
      transition: width 0.3s ease;
      border-radius: 2px;
    }
    
    /**
     * Progress percentage text styling
     */
    .progress-text {
      font-size: 11px;
      font-weight: 500;
      color: #888888;
      text-align: center;
    }

    /**
     * Empty state container for initial and no-content screens
     * Provides consistent layout for informational states
     */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 40px 20px;
      gap: 12px;
    }

    /**
     * Empty state icon styling
     * Circular background with emoji or icon content
     */
    .empty-state-icon {
      width: 48px;
      height: 48px;
      background: #f5f5f5;
      border-radius: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: #888888;
    }

    /**
     * Section header with count display
     * Flexbox layout for title and badge alignment
     */
    .section-with-count {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    /**
     * Section title styling for headers with counts
     */
    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: #1a1a1a;
      margin: 0;
    }

    /**
     * Comment input container for layout management
     */
    .comment-container {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
      position: relative;
    }

    /**
     * Character counter for comment input
     */
    .comment-counter {
      font-size: 11px;
      color: var(--color-text-muted);
      text-align: right;
      margin-top: 2px;
    }

    .comment-counter.warning {
      color: var(--color-warning);
    }

    .comment-counter.error {
      color: var(--color-error);
    }
    
    /**
     * Comment textarea styling with focus states
     * Provides user input area for changelog comments
     */
    .comment-input {
      width: 100%;
      min-height: 60px;
      max-height: 120px;
      padding: 12px 16px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-family: inherit;
      font-size: 13px;
      line-height: 1.4;
      color: #1a1a1a;
      background: #ffffff;
      resize: none;
      overflow-y: auto;
      transition: all 0.15s ease;
    }
    
    /**
     * Comment input hover state for better interactivity
     */
    .comment-input:hover {
      border-color: #d0d0d0;
    }
    
    /**
     * Comment input focus state with brand color accent
     */
    .comment-input:focus {
      outline: none;
      border-color: #007AFF;
      box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.1);
    }
    
    /**
     * Placeholder text styling for comment input
     */
    .comment-input::placeholder {
      color: #999999;
    }

    /**
     * Custom scrollbar for comment textarea
     * Thinner scrollbar for smaller input area
     */
    .comment-input::-webkit-scrollbar {
      width: 3px;
    }

    .comment-input::-webkit-scrollbar-track {
      background: transparent;
    }

    .comment-input::-webkit-scrollbar-thumb {
      background: #d0d0d0;
      border-radius: 1px;
      transition: background 0.15s ease;
    }

    .comment-input::-webkit-scrollbar-thumb:hover {
      background: #a0a0a0;
    }

    /**
     * Global scrollbar styling for all elements
     * Ensures consistent scrollbar appearance throughout the app
     */
    *::-webkit-scrollbar {
      width: 4px;
      height: 4px;
    }

    *::-webkit-scrollbar-track {
      background: transparent;
    }

    *::-webkit-scrollbar-thumb {
      background: #d0d0d0;
      border-radius: 2px;
      transition: background 0.15s ease;
    }

    *::-webkit-scrollbar-thumb:hover {
      background: #a0a0a0;
    }

    *::-webkit-scrollbar-corner {
      background: transparent;
    }
  </style>
</head>
<body>
  <!-- Main application container -->
  <div class="container" id="app">
    <!-- Initial loading state - replaced by JavaScript -->
    <div class="center-message">
      <div class="loading-spinner"></div>
      <div class="message-text">Loading...</div>
    </div>
  </div>

  <script>
    // ======================== CONSTANTS ========================

    /**
     * Application configuration constants
     * Centralizes all magic numbers and configuration values
     */
    const CONFIG = {
      /** Maximum allowed length for user comments */
      MAX_COMMENT_LENGTH: 500,
      
      /** Debounce delay for refresh operations in milliseconds (optimized) */
      REFRESH_DEBOUNCE_DELAY: 150,
      
      /** Immediate feedback delay for button clicks */
      CLICK_FEEDBACK_DELAY: 50,
      
      /** Maximum width for message text containers */
      MESSAGE_TEXT_MAX_WIDTH: 280,
      
      /** Animation duration for progress transitions */
      PROGRESS_ANIMATION_DURATION: 300,
      
      /** Locale for date formatting */
      DATE_LOCALE: 'en-US'
    };

    /**
     * UI element selectors
     * Centralizes all DOM element ID references
     */
    const SELECTORS = {
      APP_CONTAINER: 'app',
      INITIALIZE_BUTTON: 'initialize-button',
      VIEW_RECORDS_BUTTON: 'view-records-button', 
      OK_BUTTON: 'ok-button',
      BACK_BUTTON: 'back-button',
      REFRESH_BUTTON: 'refresh-button',
      ADD_TO_FIGMA_BUTTON: 'add-to-figma-button',
      SKIP_VERSION_BUTTON: 'skip-version-button',
      COMMENT_INPUT: 'comment-input'
    };

    /**
     * Message types for plugin communication
     * Ensures consistent message type strings
     */
    const MESSAGE_TYPES = {
      INITIALIZE: 'initialize',
      REFRESH: 'refresh',
      ADD_TO_FIGMA: 'addToFigma',
      SKIP_VERSION: 'skipVersion',
      VIEW_RECORDS: 'viewRecords'
    };

    // ======================== UTILITY FUNCTIONS ========================

    /**
     * Formats a timestamp into a human-readable date string.
     * Uses locale-specific formatting for better user experience.
     * 
     * @param {number} timestamp - Unix timestamp in milliseconds
     * @returns {string} Formatted date string (e.g., "Jan 15, 2024, 2:30 PM")
     */
    function formatDate(timestamp) {
      try {
        const date = new Date(timestamp);
        if (isNaN(date.getTime())) {
          throw new Error('Invalid timestamp');
        }
        
        return date.toLocaleString(CONFIG.DATE_LOCALE, {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (error) {
        console.error('Error formatting date:', error);
        return 'Invalid date';
      }
    }

    /**
     * Converts internal element types to user-friendly display names.
     * Handles legacy type names and provides consistent capitalization.
     * 
     * @param {string} type - Internal element type identifier
     * @returns {string} Human-readable type name
     */
    function formatElementType(type) {
      if (!type || typeof type !== 'string') {
        return 'Unknown';
      }

      const typeMap = {
        'component': 'Component',
        'componentSet': 'Component Set',
        'textStyle': 'Text Style',
        'colorStyle': 'Color Style',
        'paintStyle': 'Color Style', // Legacy support
        'effectStyle': 'Effect Style',
        'gridStyle': 'Grid Style',
        'variableCollection': 'Variable Collection',
        'variable': 'Variable'
      };

      return typeMap[type] || type.charAt(0).toUpperCase() + type.slice(1);
    }

    /**
     * Safely escapes HTML to prevent XSS attacks.
     * Encodes potentially dangerous characters in user input.
     * 
     * @param {string} text - Text to escape
     * @returns {string} HTML-safe escaped text
     */
    function escapeHtml(text) {
      if (!text || typeof text !== 'string') {
        return '';
      }

      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    /**
     * Validates and sanitizes user comment input.
     * Checks length limits and sanitizes content.
     * 
     * @param {string} comment - Raw comment input
     * @returns {Object} Validation result with isValid flag and sanitized comment
     */
    function validateComment(comment) {
      if (typeof comment !== 'string') {
        return { isValid: false, comment: '', error: 'Comment must be text' };
      }

      const trimmed = comment.trim();
      
      if (trimmed.length > CONFIG.MAX_COMMENT_LENGTH) {
        return { 
          isValid: false, 
          comment: trimmed, 
          error: `Comment too long (maximum ${CONFIG.MAX_COMMENT_LENGTH} characters)` 
        };
      }

      return { isValid: true, comment: trimmed, error: null };
    }

    /**
     * Formats component names with variant properties for better readability.
     * Combines parent component name with variant property values.
     * Filters out empty values and duplicate parent names.
     * 
     * @param {Object} item - Design system element object
     * @param {string} item.name - Element name
     * @param {string} item.type - Element type
     * @param {Object} [item.variantProperties] - Variant property key-value pairs
     * @param {string} [item.parentName] - Parent component set name
     * @returns {string} Formatted component name with variants
     */
    function formatComponentName(item) {
      if (!item || typeof item !== 'object') {
        return 'Unknown';
      }

      if (item.type === 'component' && item.variantProperties && 
          Object.keys(item.variantProperties).length > 0) {
        
        try {
          // If we have the parent component set name, use it instead of the component's name
          const baseName = item.parentName || item.name.split('/')[0];
          
          // Format variant properties as Prop1=Value1, Prop2=Value2
          const variantProps = item.variantProperties;
          const propKeys = Object.keys(variantProps);
          
          // Filter out any empty values or properties that might duplicate the parent name
          const filteredProps = propKeys.filter(prop => {
            const value = variantProps[prop];
            return value && value.trim() !== '' && 
                   value.toLowerCase() !== baseName.toLowerCase();
          });
          
          if (filteredProps.length > 0) {
            const variantPropsString = filteredProps
              .map(prop => `${escapeHtml(prop)}=${escapeHtml(variantProps[prop])}`)
              .join(', ');
            
            return `${escapeHtml(baseName)} (${variantPropsString})`;
          }
        } catch (error) {
          console.error('Error formatting component name:', error);
        }
      }
      
      return escapeHtml(item.name || 'Unknown');
    }
    
    // ======================== SCREEN RENDERING FUNCTIONS ========================
    
    /**
     * Renders the initial system setup screen.
     * Displayed when no tracking data exists and system needs initialization.
     * 
     * @returns {string} HTML string for initialization screen
     */
    function renderInitScreen() {
      return `
        <div class="content-container">
          <div class="empty-state">
            <div class="empty-state-icon" role="img" aria-label="Clipboard icon">📋</div>
            <h1 class="title">Initialize System</h1>
            <p class="message-text">
              Track changes to design system elements like components, styles, and variables. 
              No tracking data exists yet.
            </p>
          </div>
        </div>
        <div class="actions-container">
          <button class="button button-primary" id="${SELECTORS.INITIALIZE_BUTTON}" 
                  aria-describedby="init-description">Initialize System</button>
          <div id="init-description" class="sr-only">
            Start tracking design system changes by recording current state
          </div>
        </div>
      `;
    }
    
    /**
     * Renders the initialization completion screen.
     * Shows success message and count of recorded elements.
     * 
     * @param {number} count - Number of elements successfully recorded
     * @returns {string} HTML string for initialization complete screen
     */
    function renderInitializedScreen(count) {
      const safeCount = typeof count === 'number' && count >= 0 ? count : 0;
      
      return `
        <div class="content-container">
          <div class="empty-state">
            <div class="empty-state-icon" role="img" aria-label="Success checkmark">✅</div>
            <h1 class="title">Initialization Complete</h1>
            <p class="message-text">
              Successfully recorded ${safeCount} design system elements. 
              Future changes will be tracked automatically.
            </p>
            <p class="element-count">Elements recorded: ${safeCount}</p>
          </div>
        </div>
        <div class="actions-container">
          <button class="button button-primary" id="${SELECTORS.VIEW_RECORDS_BUTTON}">View Records</button>
          <button class="button" id="${SELECTORS.OK_BUTTON}">OK</button>
        </div>
      `;
    }
    
    /**
     * Renders the records view screen showing all tracked elements.
     * Groups elements by type and displays them in organized sections.
     * 
     * @param {Array} elements - Array of tracked design system elements
     * @param {number} timestamp - Last update timestamp
     * @returns {string} HTML string for records view screen
     */
    function renderRecordsScreen(elements, timestamp) {
      if (!Array.isArray(elements)) {
        return renderErrorScreen('Invalid records data');
      }

      const date = formatDate(timestamp);
      
      // Group elements by type for organized display
      const groupedElements = {};
      elements.forEach(element => {
        if (!element || !element.type) return;
        
        if (!groupedElements[element.type]) {
          groupedElements[element.type] = [];
        }
        groupedElements[element.type].push(element);
      });
      
      // Generate HTML for each element type group
      let elementsHtml = '';
      Object.keys(groupedElements).sort().forEach(type => {
        const items = groupedElements[type];
        if (items.length > 0) {
          elementsHtml += `
            <div class="section">
              <div class="section-with-count">
                <h2 class="section-title">${formatElementType(type)}s</h2>
                <span class="badge badge-added">${items.length}</span>
              </div>
              <div class="items-container" role="list">
                ${items.map(item => `
                  <div class="item" role="listitem">
                    <div class="item-type">${formatElementType(item.type)}</div>
                    <div class="item-name">${formatComponentName(item)}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }
      });
      
      return `
        <div class="content-container">
          <div class="section">
            <h1 class="title">Current Records</h1>
            <p class="element-count">Last updated: ${date}</p>
            <p class="element-count">Total elements: ${elements.length}</p>
          </div>
          <div class="divider"></div>
          ${elementsHtml}
        </div>
        <div class="actions-container">
          <button class="button" id="${SELECTORS.BACK_BUTTON}">Back</button>
        </div>
      `;
    }
    
    /**
     * Renders the main application screen with change detection results.
     * Displays added, modified, and removed elements with appropriate styling.
     * Includes comment input and action buttons when changes are detected.
     * 
     * @param {Object} changes - Change detection results object
     * @param {Array} changes.added - Array of newly added elements
     * @param {Array} changes.modified - Array of modified elements
     * @param {Array} changes.removed - Array of removed elements
     * @param {number} timestamp - Last scan timestamp
     * @param {boolean} hasChanges - Whether any changes were detected
     * @returns {string} HTML string for main application screen
     */
    function renderMainScreen(changes, timestamp, hasChanges) {
      if (!changes || typeof changes !== 'object') {
        return renderErrorScreen('Invalid changes data');
      }

      const date = formatDate(timestamp);
      
      // Log changes for debugging purposes
      console.log('Rendering main screen with changes:', {
        hasChanges,
        added: changes.added?.length || 0,
        modified: changes.modified?.length || 0,
        removed: changes.removed?.length || 0
      });

      /**
       * Renders a section of changes with consistent structure
       * @param {string} title - Section title
       * @param {Array} items - Array of changed elements
       * @param {string} badgeClass - CSS class for the badge
       * @returns {string} HTML for the changes section
       */
      function renderChangesSection(title, items, badgeClass) {
        if (!Array.isArray(items) || items.length === 0) {
          return '';
        }

        return `
          <div class="section">
            <div class="section-with-count">
              <h2 class="section-title">${escapeHtml(title)}</h2>
              <span class="badge ${badgeClass}">${items.length}</span>
            </div>
            <div class="items-container" role="list" aria-label="${title} elements">
              ${items.map(item => `
                <div class="item" role="listitem">
                  <div class="item-type">${formatElementType(item.type)}</div>
                  <div class="item-name">${formatComponentName(item)}</div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
      
      return `
        <div class="content-container">
          <div class="section">
            <h1 class="title">Design System Tracker</h1>
            <p class="element-count">Last scanned: ${date}</p>
          </div>
          
          ${hasChanges ? `
            <div class="divider"></div>
            ${renderChangesSection('Added', changes.added, 'badge-added')}
            ${renderChangesSection('Changed', changes.modified, 'badge-changed')}
            ${renderChangesSection('Removed', changes.removed, 'badge-removed')}
          ` : `
            <div class="section">
              <div class="no-changes">No changes detected since last update</div>
            </div>
          `}
        </div>
        
        <div class="actions-container">
          ${hasChanges ? `
            <div class="comment-container">
              <textarea 
                class="comment-input" 
                id="${SELECTORS.COMMENT_INPUT}" 
                placeholder="Describe the changes or provide context..."
                maxlength="${CONFIG.MAX_COMMENT_LENGTH}"
                aria-label="Change description comment"
                aria-describedby="comment-help"
                rows="3"
              ></textarea>
              <div class="comment-counter" id="comment-counter">
                <span id="comment-count">0</span>/${CONFIG.MAX_COMMENT_LENGTH} characters
              </div>
              <div id="comment-help" class="sr-only">
                Optional description for this changelog entry, maximum ${CONFIG.MAX_COMMENT_LENGTH} characters
              </div>
            </div>
          ` : ''}
          <button class="button button-primary" id="${SELECTORS.ADD_TO_FIGMA_BUTTON}" 
                  ${!hasChanges ? 'disabled' : ''} 
                  aria-describedby="add-to-figma-help">Add to Figma</button>
          <button class="button" id="${SELECTORS.SKIP_VERSION_BUTTON}" 
                  ${!hasChanges ? 'disabled' : ''}
                  aria-describedby="skip-version-help">Skip Version</button>
          <button class="button" id="${SELECTORS.REFRESH_BUTTON}">Refresh</button>
          <button class="button" id="${SELECTORS.VIEW_RECORDS_BUTTON}">View Records</button>
          <div id="add-to-figma-help" class="sr-only">
            Create a changelog entry in Figma with detected changes
          </div>
          <div id="skip-version-help" class="sr-only">
            Update tracking data without creating a changelog entry
          </div>
        </div>
      `;
    }
    
    /**
     * Renders a loading screen with optional progress indicator.
     * Used during async operations to provide user feedback.
     * 
     * @param {string} [message='Processing...'] - Loading message to display
     * @param {number|null} [progress=null] - Progress percentage (0-100) or null for indeterminate
     * @returns {string} HTML string for loading screen
     */
    function renderLoadingScreen(message = 'Processing...', progress = null) {
      const safeMessage = escapeHtml(message || 'Processing...');
      const safeProgress = typeof progress === 'number' && 
                          progress >= 0 && progress <= 100 ? progress : null;
      
      return `
        <div class="center-message">
          <div class="loading-spinner" role="status" aria-label="Loading"></div>
          <div class="message-text">${safeMessage}</div>
          ${safeProgress !== null ? `
            <div class="progress-container">
              <div class="progress-bar" role="progressbar" 
                   aria-valuenow="${safeProgress}" 
                   aria-valuemin="0" 
                   aria-valuemax="100"
                   aria-label="Progress ${safeProgress}%">
                <div class="progress-fill" style="width: ${safeProgress}%"></div>
              </div>
              <div class="progress-text">${safeProgress}%</div>
            </div>
          ` : ''}
        </div>
      `;
    }
    
    /**
     * Renders an error screen with retry functionality.
     * Displays error message and provides option to retry the failed operation.
     * 
     * @param {string} message - Error message to display to user
     * @returns {string} HTML string for error screen
     */
    function renderErrorScreen(message) {
      const safeMessage = escapeHtml(message || 'An unknown error occurred');
      
      return `
        <div class="center-message">
          <div class="empty-state-icon" role="img" aria-label="Warning icon">⚠️</div>
          <div class="message-text" role="alert">Error: ${safeMessage}</div>
          <button class="button button-primary" id="${SELECTORS.REFRESH_BUTTON}">Retry</button>
        </div>
      `;
    }
    
    // ======================== STATE MANAGEMENT ========================
    
    /**
     * Current changes data from the last scan
     * @type {Object|null}
     */
    let currentChanges = null;
    
    /**
     * Timeout handle for debounced refresh operations
     * @type {number|null}
     */
    let refreshTimeout = null;
    
    // ======================== EVENT HANDLING ========================
    
    /**
     * Optimized debounced refresh function to prevent rapid successive calls.
     * Provides immediate UI feedback while debouncing actual operations.
     */
    function debouncedRefresh() {
      // Immediate visual feedback
      const refreshButton = document.getElementById(SELECTORS.REFRESH_BUTTON);
      if (refreshButton) {
        refreshButton.style.opacity = '0.6';
        refreshButton.disabled = true;
      }
      
      if (refreshTimeout) {
        clearTimeout(refreshTimeout);
      } else {
        // Show loading state immediately on first call
        renderUI(renderLoadingScreen('Сканирование изменений...'));
      }
      
      refreshTimeout = setTimeout(() => {
        // Re-enable button
        if (refreshButton) {
          refreshButton.style.opacity = '';
          refreshButton.disabled = false;
        }
        
        sendMessage({ type: MESSAGE_TYPES.REFRESH });
        refreshTimeout = null;
      }, CONFIG.REFRESH_DEBOUNCE_DELAY);
    }

    /**
     * Safely sends a message to the plugin main thread with error handling.
     * Wraps postMessage calls with try-catch for robustness.
     * 
     * @param {Object} message - Message object to send
     */
    function sendMessage(message) {
      try {
        parent.postMessage({ pluginMessage: message }, '*');
      } catch (error) {
        console.error('Error sending message to plugin:', error);
        renderUI(renderErrorScreen('Communication error with plugin'));
      }
    }
    
    /**
     * Provides immediate visual feedback when a button is clicked
     */
    function addClickFeedback(button, callback) {
      if (!button) return;
      
      button.addEventListener('click', (e) => {
        // Immediate visual feedback
        button.style.transform = 'scale(0.98)';
        button.style.opacity = '0.8';
        
        // Reset after short delay
        setTimeout(() => {
          button.style.transform = '';
          button.style.opacity = '';
        }, CONFIG.CLICK_FEEDBACK_DELAY);
        
        // Execute callback after feedback
        setTimeout(() => {
          callback(e);
        }, CONFIG.CLICK_FEEDBACK_DELAY);
      });
    }

    /**
     * Sets up event listeners for all interactive elements in the current UI.
     * Dynamically attaches listeners based on elements present in the DOM.
     * Called after each UI render to ensure proper event handling.
     */
    function setupEventListeners() {
      // Initialize System button - starts the tracking system
      const initializeButton = document.getElementById(SELECTORS.INITIALIZE_BUTTON);
      addClickFeedback(initializeButton, () => {
        renderUI(renderLoadingScreen('Инициализация системы...'));
        sendMessage({ type: MESSAGE_TYPES.INITIALIZE });
      });
      
      // View Records button - shows all tracked elements
      const viewRecordsButton = document.getElementById(SELECTORS.VIEW_RECORDS_BUTTON);
      addClickFeedback(viewRecordsButton, () => {
        renderUI(renderLoadingScreen('Загрузка записей...'));
        sendMessage({ type: MESSAGE_TYPES.VIEW_RECORDS });
      });
      
      // OK button - continues from initialization complete screen
      const okButton = document.getElementById(SELECTORS.OK_BUTTON);
      addClickFeedback(okButton, () => {
        renderUI(renderLoadingScreen('Сканирование изменений...'));
        sendMessage({ type: MESSAGE_TYPES.REFRESH });
      });
      
      // Back button - returns from records view to main screen
      const backButton = document.getElementById(SELECTORS.BACK_BUTTON);
      addClickFeedback(backButton, () => {
        renderUI(renderLoadingScreen('Сканирование изменений...'));
        sendMessage({ type: MESSAGE_TYPES.REFRESH });
      });
      
      // Refresh button - rescans for changes
      const refreshButton = document.getElementById(SELECTORS.REFRESH_BUTTON);
      addClickFeedback(refreshButton, () => {
        debouncedRefresh();
      });
      
      // Comment input character counter
      const commentInput = document.getElementById(SELECTORS.COMMENT_INPUT);
      if (commentInput) {
        const updateCharacterCount = () => {
          const count = commentInput.value.length;
          const counter = document.getElementById('comment-count');
          const counterContainer = document.getElementById('comment-counter');
          
          if (counter) {
            counter.textContent = count;
          }
          
          if (counterContainer) {
            counterContainer.className = 'comment-counter';
            if (count > CONFIG.MAX_COMMENT_LENGTH * 0.9) {
              counterContainer.className += ' warning';
            }
            if (count >= CONFIG.MAX_COMMENT_LENGTH) {
              counterContainer.className += ' error';
            }
          }
        };
        
        commentInput.addEventListener('input', updateCharacterCount);
        commentInput.addEventListener('paste', () => {
          setTimeout(updateCharacterCount, 0);
        });
        
        // Auto-resize textarea
        const autoResize = () => {
          commentInput.style.height = 'auto';
          const newHeight = Math.min(commentInput.scrollHeight, 120);
          commentInput.style.height = newHeight + 'px';
        };
        
        commentInput.addEventListener('input', autoResize);
        updateCharacterCount();
        autoResize();
      }

      // Add to Figma button - creates changelog entry
      const addToFigmaButton = document.getElementById(SELECTORS.ADD_TO_FIGMA_BUTTON);
      addClickFeedback(addToFigmaButton, () => {
        if (!currentChanges) {
          renderUI(renderErrorScreen('Данные об изменениях недоступны'));
          return;
        }

        // Get and validate comment from input field
        const commentInput = document.getElementById(SELECTORS.COMMENT_INPUT);
        const rawComment = commentInput ? commentInput.value : '';
        const validation = validateComment(rawComment);
        
        if (!validation.isValid) {
          renderUI(renderErrorScreen(validation.error));
          return;
        }
        
        renderUI(renderLoadingScreen('Добавление в Figma...'));
        sendMessage({ 
          type: MESSAGE_TYPES.ADD_TO_FIGMA,
          changes: currentChanges,
          comment: validation.comment
        });
      });
      
      // Skip Version button - updates tracking without creating changelog
      const skipVersionButton = document.getElementById(SELECTORS.SKIP_VERSION_BUTTON);
      addClickFeedback(skipVersionButton, () => {
        if (!currentChanges) {
          renderUI(renderErrorScreen('Данные об изменениях недоступны'));
          return;
        }
        
        renderUI(renderLoadingScreen('Пропуск версии...'));
        sendMessage({ type: MESSAGE_TYPES.SKIP_VERSION });
      });
    }
    
    /**
     * Helper function to render UI and set up event listeners.
     * Combines DOM manipulation with event binding for complete UI updates.
     * Includes error handling for DOM operations.
     * 
     * @param {string} html - HTML string to render in the app container
     */
    function renderUI(html) {
      try {
        const appElement = document.getElementById(SELECTORS.APP_CONTAINER);
        if (!appElement) {
          console.error('App container element not found');
          return;
        }
        
        appElement.innerHTML = html;
        setupEventListeners();
      } catch (error) {
        console.error('Error rendering UI:', error);
        
        // Fallback error display
        const appElement = document.getElementById(SELECTORS.APP_CONTAINER);
        if (appElement) {
          appElement.innerHTML = renderErrorScreen('UI rendering failed');
        }
      }
    }

    // ======================== MESSAGE HANDLING ========================

    /**
     * Main message handler for plugin communication.
     * Processes messages from the plugin's main thread and updates UI accordingly.
     * Handles all plugin states and user interactions with comprehensive error handling.
     */
    window.onmessage = (event) => {
      try {
        const message = event.data.pluginMessage;
        
        if (!message || typeof message !== 'object') {
          console.warn('Received invalid message:', event.data);
          return;
        }
        
        switch (message.type) {
          case 'init':
            // Show initialization screen when no tracking data exists
            renderUI(renderInitScreen());
            break;
            
          case 'initialized':
            // Show initialization complete screen with element count
            renderUI(renderInitializedScreen(message.count));
            break;
            
          case 'scanComplete':
            // Show main screen with no changes detected
            currentChanges = { added: [], modified: [], removed: [] };
            renderUI(renderMainScreen(currentChanges, Date.now(), false));
            break;
            
          case 'changes':
            // Show main screen with detected changes
            if (message.changes && typeof message.changes === 'object') {
              currentChanges = message.changes;
              renderUI(renderMainScreen(message.changes, message.timestamp, message.hasChanges));
            } else {
              renderUI(renderErrorScreen('Invalid changes data received'));
            }
            break;
            
          case 'records':
            // Show records screen with all tracked elements
            if (Array.isArray(message.elements)) {
              renderUI(renderRecordsScreen(message.elements, message.timestamp));
            } else {
              renderUI(renderErrorScreen('Invalid records data received'));
            }
            break;
            
          case 'addedToFigma':
            // Reset after successful changelog creation
            currentChanges = { added: [], modified: [], removed: [] };
            renderUI(renderMainScreen(currentChanges, Date.now(), false));
            break;
            
          case 'versionSkipped':
            // Reset after skipping version update
            currentChanges = { added: [], modified: [], removed: [] };
            renderUI(renderMainScreen(currentChanges, Date.now(), false));
            break;
            
          case 'updated':
            // Refresh after tracking data update
            renderUI(renderLoadingScreen('Scanning for changes...'));
            sendMessage({ type: MESSAGE_TYPES.REFRESH });
            break;
            
          case 'error':
            // Show error screen with retry option
            const errorMessage = typeof message.message === 'string' ? 
                                message.message : 'Unknown error occurred';
            renderUI(renderErrorScreen(errorMessage));
            break;
            
          case 'progress':
            // Update loading screen with progress information
            const progressMessage = typeof message.message === 'string' ? 
                                  message.message : 'Processing...';
            const progress = typeof message.progress === 'number' ? 
                           message.progress : null;
            renderUI(renderLoadingScreen(progressMessage, progress));
            break;
            
          default:
            console.warn('Unknown message type:', message.type);
        }
      } catch (error) {
        console.error('Error handling plugin message:', error);
        renderUI(renderErrorScreen('Message processing failed'));
      }
    };

    // ======================== ADDITIONAL FEATURES ========================

    /**
     * Export functionality for downloading changelog data
     */
    function exportChangelog() {
      if (!currentChanges) {
        renderUI(renderErrorScreen('No changes data available for export'));
        return;
      }
      
      const exportData = {
        timestamp: Date.now(),
        changes: currentChanges,
        metadata: {
          version: '1.0.0',
          exported: new Date().toISOString(),
          plugin: 'Logify'
        }
      };
      
      const dataStr = JSON.stringify(exportData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `changelog-${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      URL.revokeObjectURL(url);
    }

    /**
     * Enhanced filtering functionality with multiple criteria
     */
    function setupAdvancedFilters() {
      const filterContainer = document.createElement('div');
      filterContainer.className = 'filter-container';
      filterContainer.innerHTML = `
        <div class="filter-group">
          <label for="type-filter">Filter by Type:</label>
          <select id="type-filter" class="filter-select">
            <option value="">All Types</option>
            <option value="component">Components</option>
            <option value="componentSet">Component Sets</option>
            <option value="textStyle">Text Styles</option>
            <option value="colorStyle">Color Styles</option>
            <option value="variable">Variables</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="search-filter">Search:</label>
          <input type="text" id="search-filter" class="filter-input" placeholder="Search by name...">
        </div>
      `;
      
      return filterContainer;
    }

    /**
     * Settings panel for plugin configuration
     */
    function renderSettingsPanel() {
      return `
        <div class="settings-panel">
          <h2 class="subtitle">Plugin Settings</h2>
          <div class="settings-group">
            <label class="settings-label">
              <input type="checkbox" id="auto-scan" class="settings-checkbox">
              Auto-scan on file changes
            </label>
          </div>
          <div class="settings-group">
            <label class="settings-label">
              <input type="checkbox" id="detailed-changes" class="settings-checkbox">
              Show detailed property changes
            </label>
          </div>
          <div class="settings-group">
            <label class="settings-label">Performance Monitoring</label>
            <select id="perf-level" class="settings-select">
              <option value="off">Disabled</option>
              <option value="basic">Basic</option>
              <option value="detailed">Detailed</option>
            </select>
          </div>
          <div class="actions-container">
            <button id="save-settings" class="primary-button">Save Settings</button>
            <button id="cancel-settings" class="secondary-button">Cancel</button>
          </div>
        </div>
      `;
    }

    /**
     * Performance dashboard for monitoring plugin efficiency
     */
    function renderPerformanceDashboard(metrics) {
      const stats = metrics || {
        totalOperations: 0,
        avgDuration: 0,
        slowOperations: 0,
        elementsProcessed: 0
      };
      
      return `
        <div class="performance-dashboard">
          <h2 class="subtitle">Performance Dashboard</h2>
          <div class="metrics-grid">
            <div class="metric-card">
              <div class="metric-value">${stats.totalOperations}</div>
              <div class="metric-label">Total Operations</div>
            </div>
            <div class="metric-card">
              <div class="metric-value">${stats.avgDuration}ms</div>
              <div class="metric-label">Avg Duration</div>
            </div>
            <div class="metric-card">
              <div class="metric-value">${stats.slowOperations}</div>
              <div class="metric-label">Slow Operations</div>
            </div>
            <div class="metric-card">
              <div class="metric-value">${stats.elementsProcessed}</div>
              <div class="metric-label">Elements Processed</div>
            </div>
          </div>
          <div class="actions-container">
            <button id="clear-metrics" class="secondary-button">Clear Metrics</button>
            <button id="export-metrics" class="secondary-button">Export Data</button>
          </div>
        </div>
      `;
    }

    /**
     * Enhanced keyboard navigation support
     */
    function setupKeyboardNavigation() {
      document.addEventListener('keydown', (event) => {
        // Handle common keyboard shortcuts
        if (event.ctrlKey || event.metaKey) {
          switch (event.key) {
            case 'r':
              event.preventDefault();
              debouncedRefresh();
              break;
            case 'e':
              event.preventDefault();
              exportChangelog();
              break;
            case 's':
              event.preventDefault();
              // Open settings panel
              break;
          }
        }
        
        // Handle escape key
        if (event.key === 'Escape') {
          const modal = document.querySelector('.modal');
          if (modal) {
            modal.remove();
          }
        }
      });
    }

    /**
     * Toast notification system for user feedback
     */
    function showToast(message, type = 'info', duration = 3000) {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 16px;
        border-radius: var(--border-radius);
        color: white;
        font-weight: 500;
        z-index: 1000;
        transition: var(--transition);
        transform: translateX(100%);
      `;
      
      // Set background color based on type
      const colors = {
        info: '#0066ff',
        success: '#00cc44',
        warning: '#ff8800',
        error: '#ff4444'
      };
      toast.style.backgroundColor = colors[type] || colors.info;
      
      document.body.appendChild(toast);
      
      // Animate in
      requestAnimationFrame(() => {
        toast.style.transform = 'translateX(0)';
      });
      
      // Auto remove
      setTimeout(() => {
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 150);
      }, duration);
    }

    // Initialize enhanced features
    setupKeyboardNavigation();

    // Add hidden accessibility helper styles
    const style = document.createElement('style');
    style.textContent = `
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        border: 0;
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html> 